#### 

## Chapter 5: Replication

数据复制的难点：需要复制的数据不是一成不变的，是持续变化的。

复制数据变化的3种发放：

* 主存复制
* 多主节点复制
* 无主节点复制

### 主存复制

* 只有主节点可以接受写请求
* 客户端角度，从节点都是只读的

#### 同步复制与异步复制

半同步：某一个从节点是同步的，其他节点则是异步模式

全异步：

* 无法保证数据的持久化（主节点失败且不可恢复，复制到从节点的写请求会丢失）
* 主节点可以继续响应从节点，系统的吞吐性能更好

#### 处理节点失效

从节点失效：追赶式恢复

主节点失效：节点切换

脑裂：两个从节点同时自认为是主节点

#### 复制日志的实现

##### 基于语句

不适用的场景：

* 任何调用`非确定性函数`的语句：NOW()、RAND()
  * 主节点在记录操作语句时，将`非确定性函`数替换为执行之后的`确定性结果`
  * 但需要考虑很多边界条件
* 使用了`自增列`、`依赖于DB的现有数据`的语句
* 有副作用的语句：触发器、存储过程、用户定义的函数

##### 基于预写日志WAL

缺点：

* 日志描述的数据结果WAL非常底层：哪些磁盘块的哪些字节发生改变
* 复制方案和存储引擎紧密耦合

##### 基于行的逻辑日志

逻辑日志

e.g., MySQL的二进制日志binlog

##### 基于触发器

应用程序层进行复制控制

### 多主节点复制



### 无主节点复制