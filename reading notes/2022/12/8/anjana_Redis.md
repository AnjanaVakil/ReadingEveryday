## 《Redis设计与实现》

黄健宏

### 2.1 SDS的定义

```c
struct sdshdr{
  int len;
  int free;
  char buf[];
};
```

SDS遵循`C字符串`以`空字符`结尾的惯例，保存空字符的1字节空间不计算在SDS的len属性里面，并且为空字符分配额外的1字节空间，以及添加空字符到字符串末尾等操作，都是由SDS函数自动完成的，所以这个空字符对于SDS的使用者来说是完全透明的。

### 2.2 SDS与C字符串的区别

与C字符串不同，SDS的空间分配策略完全杜绝了发生`缓冲区溢出`的可能性：当SDS API需要对SDS进行修改时，API会先检查SDS的空间是否满足修改所需的要求，如果不满足的话，API会自动将SDS的空间扩展至执行修改所需的大小，然后才执行实际的修改操作，所以使用SDS既不需要手动修改SDS的空间大小，也不会出现前面所说的缓冲区溢出问题。 

通过未使用空间，SDS实现了空间预分配和惰性空间释放两种优化策略。