## 第五章 保护模式进阶，向内核迈进

### 检测内存容量

在 Linux 中有多种方法获取内存容量，如果一种方法失败，就会试用其他方法。

- EAX=0xE820：遍历主机上全部内存。

- AX=0xE801： 分别检测低 15MB 和 16MB～4GB 的内存，最大支持 4GB。

- AH=0x88：最多检测出 64MB 内存，实际内存超过此容量也按照 64MB 返回。

BIOS 中断可以返回已安装的硬件信息，由于 BIOS 及其中断也只是一组软件，它要访问硬件也要依 靠硬件提供的接口，所以，获取内存信息，其内部是通过连续调用硬件的应用程序接口（Application Program Interface，API）来获取内存信息的。

虽然我们介绍了三个检测方法，但这个 0x02000000 却是 BIOS 0x15 中断子功能 0xe820 的功劳，另外两 个子功能没用上。大家可以在 bochs 中跟一下代码执行的情况，本程序实际运行情况是在方法 0xe820 中， int 0x15 执行了 6 次，返回了 6 个 ARDS 结构。

### 内存分页

#### 为什么要分页？

仅分段的问题：

![image-20230817103718414](https://wtsclwq.oss-cn-beijing.aliyuncs.com/image-20230817103718414.png)

两个解决方案。 

- 等待进程 C 运行完后腾出内存，这样连续可用的内存就够运行进程 D 了。
- 将进程 A 的段 A3 或进程 C 的段 C1 换出到硬盘上，腾出一部分空间，加上邻接的 20MB，足够容 纳进程 D。

