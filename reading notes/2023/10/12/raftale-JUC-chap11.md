线程最主要的目的是提高程序的运行性能，但提升性能的同时也增加了复杂度，也就增加了在安全性和活跃性上发生失败的风险。保证程序正确运行的前提下，提高性能才有意义。



# 对性能的思考

提升性能意味着用更少的资源做更多的事情，资源包括了CPU时钟周期、内存、网络带宽、I/O带宽、数据库请求、磁盘空间以及其他资源。当操作性能由于某种特定的资源而收到限制时，我们通常将该操作称为资源密集型的操作，例如，CPU密集型、数据库密集型等。

尽管使用多个线程的目标是提升整体性能，但与单线程的方法相比，使用多个线程总会引入一些额外的开销。造成这些开销的操作包括：线程之间的协调（例如加锁、触发信号以及内存同步）、增加的上下文切换、线程的创建和销毁、线程的调度等。如果过度使用线程，那么这些开销甚至超过性能提升。

要想通过并发来获得更好的性能，需要努力做好两件事情：更有效地利用现有资源，以及在出现新的处理资源时使程序尽可能地利用这些新资源。从性能监视的视角来看，CPU需要尽可能保持有意义的忙碌状态。



## 性能与可伸缩性

应用程序的性能可以采用多个指标来衡量：服务时间、延迟时间、吞吐率、效率、可伸缩性、容量等。

其中一些指标如服务时间、延迟时间用于衡量程序的运行速度，另一些指标如吞吐量用于程序的处理能力，即在计算资源一定的情况下，能完成多少工作。可伸缩性是指：当增加计算资源时，程序的吞吐量或者处理能力能相应地增加。

性能的两个方面：多快和多少是完全独立的，有时候甚至是相互矛盾的，要实现更高的可伸缩性或硬件利用率，通常会增加各个任务要处理的工作量，例如把任务分解为多个「流水线」任务时，如常见的MVC模型，因为抽象也是有性能开销的，但好的抽象有时能利用更多的资源。

本章重点介绍的是可伸缩性而不是单线程程序的性能。

## 评估各种性能权衡因素

性能优化要保守，性能优化几乎都会有某种形式的成本开销。



以测试为基准，不要猜测。



## Amdahl定律

Amdahl定理描述的是：在增加计算资源的情况下，程序在理论上能够实现最高加速比，这个值取决于程序中可并行组件与串行组件所占的比重。假定F是必须被串行执行的部分，那么根据Amdahl定律，在包含N个处理器的机器中，最高加速比为：


当N趋近于无穷大时，最大的加速比趋近于1/F。因此，

1. 如果有50%的计算需要串行执行，那么最高的加速比只能为2；
2. 如果程序中有10%的计算需要串行执行，那么最高的加速比将接近于10；
3. 在拥有10个处理器的系统中，如果程序中有10%的部分需要串行执行，那么最高的加速比为5.3；
4. 在拥有100个处理器的系统中，如果程序中有10%的部分需要串行执行，那么最高的加速比为9.2；



下图给出了**处理器利用率**在不同串行比例以及处理器情况下的变化曲线：


**处理器利用率的定义为：加速比除以处理器的数量**

随着处理器数量的增加，即使串行部分的所占百分比很小，也会极大限制当增加计算资源时能够提升的吞吐率。

串行部分操作包括：加锁同步的操作、对结果进行处。
