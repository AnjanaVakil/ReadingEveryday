## 中断
中断是一种特殊的情况，当它发生时，CPU会停止当前的指令执行，并转移到专门的代码来处理该事件。

## 可能导致中断的事件
1. 系统调用（System Call）：当用户程序执行ecall指令请求内核为其执行某些操作时，会触发系统调用。
2. 异常（Exception）：当一个指令（用户级别或内核级别的）执行了非法操作，例如除以零或使用无效的虚拟地址时，会发生异常。
3. 设备中断（Device Interrupt）：当设备需要注意时，例如硬盘在完成读或写请求后，会发生设备中断。

## trap
它是一种机制，当程序需要操作系统提供服务，或者程序发生错误，或者硬件设备需要处理时，系统会被“陷入”内核代码执行相应的处理程序。

| 事件类型 | 描述 | 处理流程 |
|---|---|---|
| 系统调用 (System Call) | 用户程序执行ecall指令，请求内核进行某种操作。 | 1. 陷阱引起内核控制权的转移。<br>2. 内核保存寄存器和其他状态。<br>3. 内核执行适当的处理程序（例如，系统调用实现）。<br>4. 内核恢复保存的状态并从陷阱返回。<br>5. 原始代码在中断的地方恢复执行。 |
| 异常 (Exception) | 用户或内核指令执行非法操作，例如除以零或使用无效的虚拟地址。 | 与系统调用的处理流程相同，但在xv6中，所有来自用户空间的异常都会导致程序被终止。 |
| 设备中断 (Device Interrupt) | 设备发出信号表示需要注意，例如硬盘完成读或写请求。 | 处理流程与系统调用相同，但是设备中断通常对被中断的代码是透明的，因为被中断的代码通常不预期设备中断。 |

Xv6的陷阱处理流程：
| 阶段 | 描述 |
|---|---|
| 1. 硬件动作 | RISC-V CPU执行的硬件操作。 |
| 2. 准备工作 | 一些汇编指令为内核C代码准备。 |
| 3. 陷阱处理决策 | 一个C函数决定如何处理陷阱。 |
| 4. 服务程序执行 | 系统调用或设备驱动服务程序的执行。 |

注意：虽然所有的陷阱类型在处理上有共性，但是对于来自用户空间的陷阱、来自内核空间的陷阱和计时器中断这三种不同情况，有独立的代码处理是更为方便的。处理陷阱的内核代码（汇编或C）通常被称为处理程序；第一个处理程序指令通常用汇编编写（而不是C），有时被称为向量。

