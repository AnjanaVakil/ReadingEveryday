## trampoline
- 用户模式下的陷阱可能发生在用户程序进行系统调用，执行非法操作，或设备中断时。陷阱处理的高级路径从uservec开始，然后是usertrap，最后通过usertrapret和userret返回。
- xv6处理陷阱的一个主要限制是，RISC-V硬件在强制陷阱时并不切换页表。这意味着stvec中的陷阱处理程序地址必须在用户页表中有有效的映射，因为这是陷阱处理代码开始执行时生效的页表。此外，xv6的陷阱处理代码需要切换到内核页表；为了在切换后能够继续执行，内核页表也必须为stvec指向的处理程序有映射。
- 为了满足这些需求，xv6使用了一个“弹板页”。弹板页包含uservec，即stvec指向的xv6陷阱处理代码。弹板页在每个进程的页表中都映射到地址TRAMPOLINE，这个地址位于虚拟地址空间的末尾，因此会位于程序自用的内存之上。弹板页也在内核页表的地址TRAMPOLINE处映射。

## 处理用户模式下的陷阱（trap）
| 步骤 | 描述 |
| ---- | ---- |
| 1. 用户模式陷阱 | 用户程序可能会因为系统调用、非法操作或设备中断而产生陷阱。|
| 2. uservec 和 usertrap | 陷阱首先进入 uservec (位于 kernel/trampoline.S:16)，然后进入 usertrap (位于 kernel/trap.c:37)。|
| 3. Trampoline 页面 | xv6 使用了一个被称为 "trampoline" 的页，用于满足在用户和内核页表间切换的需求。 |
| 4. 保存寄存器 | 当 uservec 开始时，需要保存所有 32 个被用户代码使用的寄存器。|
| 5. 处理陷阱 | usertrap 的任务是确定陷阱的原因，处理它，并返回。|
| 6. 系统调用处理 | 如果陷阱是系统调用，usertrap 会调用 syscall 来处理它。|
| 7. 返回用户空间 | 在返回用户空间的过程中，首先会调用 usertrapret (kernel/trap.c:90)。|
| 8. userret | 在 usertrapret 结束后，会调用位于 trampoline 页的 userret (kernel/trampoline.S:88)，以准备回到用户空间。|

这个过程确保了在用户模式和内核模式之间切换时，能够保存和恢复所有的寄存器，并且能够正确地处理各种可能的陷阱。

