## 相关寄存器
| Register | Description |
| --- | --- |
| stvec | 内核在此处写入其陷阱处理程序的**地址**；RISC-V跳转到stvec中的地址以处理陷阱。|
| sepc | 当陷阱发生时，RISC-V在此**保存程序计数器**（因为PC将被stvec中的值覆盖）。sret（从陷阱返回）指令将sepc复制到pc。内核可以写sepc来控制sret去向。|
| scause | RISC-V在此放置一个**描述陷阱原因**的数字。|
| sscratch | 内核在此放置一个在陷阱处理程序开始时会派上用场的值。|
| sstatus | sstatus中的**SIE位**控制是否启用设备中断。如果内核清除了SIE，RISC-V会延迟设备中断，直到内核设置了SIE。**SPP位**表示陷阱是来自用户模式还是监督模式，并控制sret返回到哪个模式。|

- 上述寄存器与在监督模式下处理的陷阱有关，不能在用户模式下读取或写入。对于在机器模式下处理的陷阱，有一组类似的控制寄存器；xv6只在处理计时器中断的特殊情况下使用它们。

- 每个多核芯片上的CPU都有自己的这些寄存器的一套，而且可能有多个CPU在任何给定时间都在处理陷阱。

当RISC-V硬件需要强制陷阱时，除计时器中断外，对所有陷阱类型都执行以下操作：
| Trap Handling Steps | Description |
| --- | --- |
| 1 | 如果陷阱是设备中断，并且sstatus的SIE位已清除，则不执行以下任何操作。|
| 2 | 通过清除sstatus中的SIE位禁用中断。|
| 3 | 将pc复制到sepc。|
| 4 | 在sstatus的SPP位中保存当前模式（用户或监督）。|
| 5 | 设置scause以反映陷阱的原因。|
| 6 | 将模式设置为监督。|
| 7 | 将stvec复制到pc。|
| 8 | 在新的pc处开始执行。|

- CPU在陷阱过程中并不切换到内核页表，也不切换到内核中的栈，除程序计数器（PC）外也不保存任何寄存器的值。这些任务都必须由内核软件执行。CPU在陷阱处理过程中工作量较小的一个原因是为了给软件提供更大的灵活性；例如，某些操作系统在某些情况下可能会省略页表切换，以提高陷阱处理的性能。

- 在大多数情况下，省略许多步骤可能是危险的。例如，假设CPU没有切换程序计数器，那么来自用户空间的陷阱可能会在仍在执行用户指令的情况下切换到监督模式。这些用户指令可能会破坏用户/内核隔离，例如通过修改satp寄存器来指向允许访问所有物理内存的页表。因此，CPU切换到内核指定的指令地址（即stvec）是非常重要的。