## 验证

验证是为了保证虚拟机自身的安全

### 文件格式验证

该阶段验证的目的是保证输入的字节流能正确地解析并存储于方法区之内。其余阶段的验证都是基于方法区的存储结构上进行的。

### 元数据验证

第二阶段的验证是对字节描述的信息进行语义分析，以保证其描述的信息符合《Java语言规范》的要求，可能的验证点有：

1. 这个类是否有父类
2. 这个类的父类是否继承了不允许被继承的类
3. 如果这个类不是抽象类，是否实现了其父类或接口中要求实现的所有方法
4. 。。。

主要目的是对类的元数据信息进行语义校验，保证不存在与Java语言规范定义相悖的元数据信息。

### 字节码验证

目的是通过数据流分析和控制流分析，确定 程序语义是合法的、符合逻辑的。

这阶段 主要是对类的方法体(Class文件中的Code属性)进行校验分析，保证被校验类的方法在运行时不会做出危害 虚拟机安全的行为。

- 保证任何跳转指令都不会跳转到方法体以外的字节码指令上
- 。。。

### 符号引用验证

最后一个阶段的校验行为发生在虚拟机将符号引用转化为直接引用的时候，这个转化动作将在 连接的第三阶段——解析阶段中发生。



## 准备

准备阶段是正式为类中定义的变量（静态变量）分配内存并设置类变量初始值的阶段。

1. 这时候进行内存分配的仅包括类变量，不包括实例变量。
2. 初始值是数据类型的零值，赋值动作要到类的初始化阶段才会执行。

1. 1. 例外的是final static修饰的字段在准备阶段就会赋值。

## 解析

解析是JVM将常量池内的符号引用替换为直接引用的过程



1. 类或接口的解析
2. 字段解析
3. 方法解析
4. 接口方法解析



## 初始化

类的初始化阶段是类加载过程的最后一个步骤，直到初始化阶段，JVM才真正开始执行类中编写的Java程序代码，将主导权移交给应用程序。

类的初始化阶段就是执行类构造器<client>()方法的过程。<client>()方法是Javac编译器的自动生成物。

〈clinit>()方法是由编译器自动收集类中的所有类变量的赋值动作和静态语句块（static{} 块）中的语句合并产生的，编译器手机的顺序是由语句在源文件中出现的顺序决定的。静态语句块中只能访问到定义在静态语句块之前的变量，定义在它之后的变量，在前面的语句块可以赋值，但是不能访问。

```java
public class Test {
    static {
        i = 0; // 给变量赋值可以正常编译通过
        System.out.print(i); // 这句话编译器会提示「非法向前引用」Illegal forward reference
    }
    static int i = 1;

  public static void main(String[] args) {
    System.out.println(i);  // i = 1
  }
}
```





JVM会保证子类的<client>()执行前，父类的<client>()已经被执行

由于父类的<client>()先执行，父类中定义的静态语句块要优先于子类的变量赋值操作。

```java
static class Parent {
    public static int A = 1;
    static {
        A = 2;
    }
}

static class Sub extends Parent {
    public static int B = A;
}
public static void main(String[] args) {
    System.out.println(Sub.B); // 2
}
```



JVM必须保证一个类的<client>()方法在多线程环境下被正确地加锁同步，多个线程同时初始化一个类，只有一个线程会成功执行，其他线程会阻塞等待，唤醒后也不会再执行<client>()方法。
