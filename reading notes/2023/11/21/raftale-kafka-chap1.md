# 发布与订阅系统



broker：发布消息的中心点

发布订阅系统最重要的功能之一就是对各个服务间的联系进行了解耦。

# Kafka

Kafka就是一款基于发布与订阅的消息系统。它一般被称为「分布式提交日志」或者「分布式流平台」。

Kakfa的数据是按照一定顺序持久化保存的，可以按需读取，此外由于Kafka的数据分布在整个系统里，具备数据故障保护和性能伸缩能力。

## 消息与批次

Kafka的数据单元被称为消息，消息由字节数数组组成，所以对于Kafka来说，消息里的数据没有特别的格式或者含义。

为了提高效率，消息被分批次写入Kafka。批次就是一组消息，这些消息属于同一个主题和分区。消息分成批次可以减少网络开销，但批次的大小是时间延迟和吞吐量之间的权衡。

## 模式

对于kafka来说，消息不过时晦涩难懂的字节数组。消息模式有许多可用的选项，如Json和xml，不过Kafka的许多开发者喜欢Apache Avro，它最初是为Hadoop开发的一款序列码。

数据格式的一致性对Kafka来说很重要，它消除了消息读写操作之间的耦合性。如果读写操作紧密的耦合在一起，消息订阅者需要升级应用程序才能同时处理新旧两种数据格式。

## 主题和分区




消息通过主题进行分类。

主题可以进行分区，分区的目的是为了可伸缩性。消息以追加的方式写入分区，同一个分区的消息可以保证有序性，如果一个主题有多个分区，分区之间是无法保证有序性的。

实时的方式处理消息，也就是所谓的流式处理。



## 生产者与消费者

Kafka的客户端其实就是Kafka系统 的用户。它们被分为两种基本类型：生产者和消费者。

1. 生产者创建消息：默认情况下消息会均衡的分布到主题的所有分区上，但如果指定了分区键和分区算法，也是可以映射到指定的分区。
2. 消费者读取消息：消费者订阅一个或多个主题，并按照消息生成的顺序读取它们。消费者通过检查消息的偏移量来区分已经读取过的消息。

1. 1. 偏移量是另一种元数据，它是一个不断递增的整数值，在创建消息时，Kafka会把它添加到消息里。在给定的分区里，每个消息的偏移量都是唯一的。
2. 消费者会把每个分区最后读取的消息偏移量保存在zookeeper或者kafka上，如果消费者关闭或者重启，它的读取状态不会丢失
3. 消费者是消费者群组的一部分。也就是说，会有一个或者多个消费者共同读取一个主题。群组保证每个分区只能被一个消费者使用



## broker和集群



一个独立的kafka服务器被称为broker。

1. broker接受来自生产者的消息，为消息设置偏移量，并提交消息到磁盘保存。
2. broker为消费者提供服务，对读取分区的请求作出响应，返回已经提交到磁盘上的消息。
3. 根据特定的硬件及性能特征，单个broker可以轻松处理数千个分区以及每秒百万级的消息量
