
# 低延迟垃圾收集器

Shenandoash

## ZGC收集器

Z garbage collections

JDK11

目标：尽可能对吞吐量影响不大的前提下，实现任意堆内存大小都可以把垃圾收集的停顿时间限制在十毫秒以内的低延迟。

定义：内部布局基于Region，不设分代，使用了读屏障、染色指针和内存多重映射等技术来实现可并发的标记-整理算法的，以低延迟为首要目标的一款垃圾收集器。

内存布局：Region可以动态的创建与销毁

1. 小Region：固定为2M，放置小于256KB的小对象
2. 中Region：固定为32M，放置大于等于256KB但小于4MB的对象
3. 大型Region：容量不固定，可以动态变化。每个Region只会存放一个大对象。大型Region不会被重分配，因为复制一个大对象的代价非常高昂。


ZGC的核心问题：并发整理算法的实现。



染色指针

染色指针是一种直接将少量额外的信息存储在指针上的技术，ZGC存粗了四个标志信息，JVM可以看到其引用对象的三色标记状态、是否进入了重分配集、是否通过finalize()方法才能被访问到。

染色指针的好处：

1. 染色指针可以使得一旦某个Region的存活对象被移走之后，这个Region立即就能够被释放和重用掉。
2. 染色指针可以大幅减少在垃圾回收过程中内存屏障的使用数量




ZGC收集器的运作过程可以划分为以下四个大的阶段，这四个大阶段都是可以并发执行的。

1. 并发标记：遍历对象图做可达性分析，与G1的区别是，ZGC的标记是在指针上而不是在对象上进行的。标记阶段会更新染色指针中的marked0、marked1标志位。
2. 并发预备重分配： 根据特定的查询条件统计出本次收集过程要清理哪些Region，将这些Region组成重分配集（Relocation Set）。
3. 并发重分配：把重分配集中的存活对象复制到新的Region上，并为重分配集中的每个Region维护一个转发表（Forward Table），记录从旧对象到新对象的转向关系。

1. 1. 当用户线程并发访问时，访问将被预置的内存屏障捕获，ZGC然后立即根据Region上的转发表记录将访问转发到新复制的Region中，并同时修改该引用的值为新对象。这种行为被称为指针的「自愈」能力。

1. 1. 1. 好处是只有第一次访问旧对象时会陷入转发。

1. 并发重映射：修正整个堆中指向重分配集中旧对象的所有引用。



对比之下，ZGC的特点：无分代，所以也没有记录跨代引用的记忆集和写屏障，



ZGC的优势：

1. 吞吐量高达99%
2. 平均停顿时间在10ms内
